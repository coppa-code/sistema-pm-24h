// üßÆ CALCULAR IDADE SEGURA - SUPORTA AMBOS OS FORMATOS
function calculateAge(dateString) {
    try {
        if (!dateString || dateString.trim() === '') {
            console.log(`‚ö†Ô∏è Data vazia para c√°lculo de idade`);
            return 0;
        }
        
        let day, month, year;
        
        // ‚úÖ DETECTAR FORMATO DA DATA
        if (dateString.includes('/')) {
            // Formato brasileiro: DD/MM/YYYY
            const dateParts = dateString.split('/');
            if (dateParts.length < 3) {
                console.log(`‚ö†Ô∏è Data brasileira incompleta: ${dateString}`);
                return 0;
            }
            [day, month, year] = dateParts;
        } else if (dateString.includes('-')) {
            // Formato americano: YYYY-MM-DD
            const dateParts = dateString.split('-');
            if (dateParts.length < 3) {
                console.log(`‚ö†Ô∏è Data americana incompleta: ${dateString}`);
                return 0;
            }
            [year, month, day] = dateParts;
        } else {
            console.log(`‚ö†Ô∏è Formato de data n√£o reconhecido: ${dateString}`);
            return 0;
        }
        
        if (!day || !month || !year) {
            console.log(`‚ö†Ô∏è Partes da data vazias: ${dateString}`);
            return 0;
        }
        
        const birth = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
        const today = new Date();
        
        // Verificar se a data √© v√°lida
        if (isNaN(birth.getTime())) {
            console.log(`‚ö†Ô∏è Data inv√°lida ap√≥s convers√£o: ${dateString}`);
            return 0;
        }
        
        let age = today.getFullYear() - birth.getFullYear();
        const monthDiff = today.getMonth() - birth.getMonth();
        
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
            age--;
        }
        
        return age > 0 ? age : 0;
    } catch (error) {
        console.error(`‚ùå Erro ao calcular idade para "${dateString}":`, error.message);
        return 0;
    }
}

// üìÖ VERIFICAR QUEM FAZ ANIVERS√ÅRIO AMANH√É - SUPORTA AMBOS OS FORMATOS
function checkTomorrowBirthdays(birthdays) {
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    
    const tomorrowDay = tomorrow.getDate().toString().padStart(2, '0');
    const tomorrowMonth = (tomorrow.getMonth() + 1).toString().padStart(2, '0');
    
    console.log(`üîç Verificando anivers√°rios para AMANH√É: ${tomorrowDay}/${tomorrowMonth}`);
    
    const tomorrowBirthdays = birthdays.filter(birthday => {
        try {
            if (!birthday || !birthday.date || birthday.date.trim() === '') {
                console.log(`‚ö†Ô∏è Data vazia para: ${birthday?.name || 'Nome n√£o informado'}`);
                return false;
            }
            
            let day, month;
            
            // ‚úÖ DETECTAR E PROCESSAR FORMATO DA DATA
            if (birthday.date.includes('/')) {
                // Formato brasileiro: DD/MM/YYYY
                const dateParts = birthday.date.split('/');
                if (dateParts.length < 2) {
                    console.log(`‚ö†Ô∏è Data brasileira incompleta para ${birthday.name}: ${birthday.date}`);
                    return false;
                }
                day = dateParts[0];
                month = dateParts[1];
            } else if (birthday.date.includes('-')) {
                // Formato americano: YYYY-MM-DD
                const dateParts = birthday.date.split('-');
                if (dateParts.length < 3) {
                    console.log(`‚ö†Ô∏è Data americana incompleta para ${birthday.name}: ${birthday.date}`);
                    return false;
                }
                // YYYY-MM-DD -> extrair MM e DD
                month = dateParts[1]; // MM
                day = dateParts[2];   // DD
            } else {
                console.log(`‚ö†Ô∏è Formato de data n√£o reconhecido para ${birthday.name}: ${birthday.date}`);
                return false;
            }
            
            if (!day || !month || day.trim() === '' || month.trim() === '') {
                console.log(`‚ö†Ô∏è Dia ou m√™s vazio para ${birthday.name}: ${birthday.date}`);
                return false;
            }
            
            const birthdayDay = day.toString().trim().padStart(2, '0');
            const birthdayMonth = month.toString().trim().padStart(2, '0');
            
            const match = birthdayDay === tomorrowDay && birthdayMonth === tomorrowMonth;
            
            if (match) {
                console.log(`üéÇ ENCONTRADO: ${birthday.graduation || 'Sem gradua√ß√£o'} ${birthday.name || 'Sem nome'} - ${birthday.date} (${birthday.date.includes('/') ? 'BR' : 'US'} format)`);
            }
            
            return match;
            
        } catch (error) {
            console.error(`‚ùå Erro ao processar anivers√°rio de ${birthday.name || 'Nome desconhecido'}:`, error.message);
            return false;
        }
    });
    
    console.log(`üìä Total de anivers√°rios AMANH√É: ${tomorrowBirthdays.length}`);
    return tomorrowBirthdays;
}

// üõ°Ô∏è CONTROLE DE LIMITE TWILIO MELHORADO
let dailyMessageCount = 0;
const MAX_DAILY_MESSAGES = 3; // ‚ö†Ô∏è REDUZIDO PARA EVITAR LIMITE
let twilioLimitReached = false;

// üì± FUN√á√ÉO OTIMIZADA COM CONTROLE DE LIMITE TWILIO
async function sendWhatsAppMessage(to, message) {
    // ‚úÖ VERIFICAR SE J√Å ATINGIU LIMITE TWILIO
    if (twilioLimitReached) {
        console.log(`üö´ LIMITE TWILIO ATINGIDO - Mensagem n√£o enviada para economizar`);
        throw new Error('Limite Twilio atingido - Mensagem bloqueada para economizar');
    }

    if (dailyMessageCount >= MAX_DAILY_MESSAGES) {
        console.log(`‚ö†Ô∏è LIMITE DI√ÅRIO INTERNO ATINGIDO: ${dailyMessageCount}/${MAX_DAILY_MESSAGES}`);
        throw new Error(`Limite di√°rio interno atingido (${dailyMessageCount}/${MAX_DAILY_MESSAGES})`);
    }

    try {
        let fetch;
        
        try {
            fetch = globalThis.fetch;
            if (!fetch) {
                const nodeFetch = await import('node-fetch');
                fetch = nodeFetch.default || nodeFetch;
            }
        } catch (error) {
            console.error('‚ùå Erro ao importar fetch:', error);
            throw new Error('Fetch n√£o dispon√≠vel');
        }

        const url = `https://api.twilio.com/2010-04-01/Accounts/${CONFIG.twilio.accountSid}/Messages.json`;
        const toNumber = to.startsWith('whatsapp:') ? to : `whatsapp:${to}`;
        
        console.log('üì§ Enviando mensagem WhatsApp...');
        console.log(`üìû Para: ${toNumber}`);
        console.log(`üìù Tamanho: ${message.length} caracteres`);
        
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Authorization': 'Basic ' + Buffer.from(`${CONFIG.twilio.accountSid}:${CONFIG.twilio.authToken}`).toString('base64'),
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams({
                From: CONFIG.twilio.fromNumber,
                To: toNumber,
                Body: message
            })
        });

        if (!response.ok) {
            const errorText = await response.text();
            console.error('‚ùå Resposta Twilio:', response.status, errorText);
            
            // ‚úÖ DETECTAR LIMITE TWILIO E MARCAR FLAG
            if (response.status === 429 || errorText.includes('63038')) {
                twilioLimitReached = true;
                console.error('üö´ LIMITE TWILIO DETECTADO - Bloqueando pr√≥ximas tentativas');
            }
            
            throw new Error(`Twilio Error ${response.status}: ${errorText}`);
        }

        const result = await response.json();
        
        dailyMessageCount++;
        console.log(`‚úÖ WhatsApp enviado com sucesso!`);
        console.log(`üìä Mensagens hoje: ${dailyMessageCount}/${MAX_DAILY_MESSAGES}`);
        console.log(`üÜî SID: ${result.sid}`);
        
        return result;
        
    } catch (error) {
        console.error('‚ùå Erro detalhado no envio WhatsApp:', error);
        
        if (error.message.includes('63038') || error.message.includes('429')) {
            twilioLimitReached = true;
            console.error('üö´ LIMITE TWILIO ATINGIDO - Bloqueando pr√≥ximas tentativas');
        }
        
        throw error;
    }
}

// ü§ñ EXECU√á√ÉO PRINCIPAL OTIMIZADA COM CONTROLE DE LIMITE
async function executeAutomaticCheck(periodo = 'padr√£o') {
    const brasilTime = new Date().toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' });
    console.log(`üéñÔ∏è === EXECU√á√ÉO AUTOM√ÅTICA PM (${periodo.toUpperCase()}) === ${brasilTime}`);
    
    // ‚úÖ VERIFICAR SE LIMITE TWILIO FOI ATINGIDO
    if (twilioLimitReached) {
        console.log(`üö´ EXECU√á√ÉO CANCELADA - Limite Twilio atingido (${periodo})`);
        return;
    }
    
    try {
        const allBirthdays = await getBirthdaysFromFirebase();
        
        if (allBirthdays.length === 0) {
            console.log('üìã Nenhum anivers√°rio encontrado no Firebase');
            return;
        }
        
        const tomorrowBirthdays = checkTomorrowBirthdays(allBirthdays);
        
        if (tomorrowBirthdays.length === 0) {
            console.log(`‚ÑπÔ∏è Nenhum anivers√°rio AMANH√É (${periodo})`);
            
            // ‚úÖ REMOVER TESTE DE FIM DE SEMANA PARA ECONOMIZAR MENSAGENS
            console.log(`üí° Nenhuma mensagem enviada - Economizando limite Twilio`);
            return;
        }
        
        // ‚úÖ ENVIAR MENSAGEM APENAS SE HOUVER ANIVERS√ÅRIOS
        console.log(`üéÇ ENVIANDO 1 MENSAGEM √öNICA com ${tomorrowBirthdays.length} aniversariante(s)...`);
        
        const combinedMessage = createCombinedBirthdayMessage(tomorrowBirthdays, periodo);
        const result = await sendWhatsAppMessage(CONFIG.twilio.toNumber, combinedMessage);
        
        console.log(`‚úÖ MENSAGEM √öNICA ENVIADA - SID: ${result.sid}`);
        console.log(`üéÇ Aniversariantes: ${tomorrowBirthdays.map(b => `${b.graduation || 'Sem gradua√ß√£o'} ${b.name || 'Sem nome'}`).join(', ')}`);
        
        console.log(`üìä RELAT√ìRIO FINAL (${periodo}):`);
        console.log(`   ‚úÖ Mensagem enviada: 1`);
        console.log(`   üéÇ Aniversariantes: ${tomorrowBirthdays.length}`);
        console.log(`   üí∞ Economia: ${tomorrowBirthdays.length - 1} mensagens poupadas`);
        console.log(`   üìä Mensagens hoje: ${dailyMessageCount}/${MAX_DAILY_MESSAGES}`);
        
    } catch (error) {
        console.error(`‚ùå Erro na execu√ß√£o autom√°tica (${periodo}):`, error.message);
        
        // ‚úÖ N√ÉO ENVIAR ALERTA DE ERRO SE LIMITE TWILIO ATINGIDO
        if (twilioLimitReached || error.message.includes('Limite Twilio atingido')) {
            console.log(`üö´ Alerta de erro n√£o enviado - Limite Twilio atingido`);
            return;
        }
        
        // Tentar enviar erro apenas se ainda h√° limite
        try {
            if (dailyMessageCount < MAX_DAILY_MESSAGES) {
                const errorMessage = `‚ùå *ERRO SISTEMA PM* üö®

‚è∞ *Hor√°rio:* ${new Date().toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' })}
üîß *Per√≠odo:* ${periodo}
‚ö†Ô∏è *Erro:* ${error.message}

üí° *Verificar logs no Render para mais detalhes*

---
_Sistema PM - Alerta de Erro v2.4.0_ ‚ö†Ô∏è`;

                await sendWhatsAppMessage(CONFIG.twilio.toNumber, errorMessage);
            }
        } catch (e) {
            console.error('‚ùå Erro ao enviar alerta de erro:', e);
        }
    }
}

// Reset flags √†s 00:00 UTC
cron.schedule('0 0 * * *', () => {
    dailyMessageCount = 0;
    twilioLimitReached = false; // ‚úÖ RESETAR FLAG TWILIO
    console.log('üîÑ Contador de mensagens e flag Twilio resetados para novo dia');
}, {
    timezone: "UTC"
});
